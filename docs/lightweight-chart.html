<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Light weigth charts</title>
    <script src="lightweight-charts.standalone.development2.js"></script>
    <script src="data.js"></script>
    <style type="text/css">
      body { background-color: #fff; padding: 0; margin: 0; }
    </style>
  </head>
  <body>
    <div id="ticker" style="width: 70%;height: 380px; margin: 0 auto; position: relative;"></div>

    <!-- <div style="width: 80px;height: 30px;margin: 0 auto 10px;padding-top: 20px;margin-top: 30px;">
      <button type="button" id="handleEvent" style="padding: 8px 20px;">Apply</button>
    </div> -->

    <script>
        function getRandomPosition() {
          var position = {};
          var doc = document.getElementById("ticker");
          position.top = Math.floor(Math.random() * (document.getElementById("ticker").offsetWidth - 100));
          position.left = Math.floor(Math.random() * (document.getElementById("ticker").offsetHeight - 100));
          return position;
        }

        function showMessage(message) {
          var position = getRandomPosition();
          
          var messageElement = document.createElement("div");
          messageElement.textContent = message;
          messageElement.className = "wwwwww";
          messageElement.style.backgroundColor = "yellow";
          messageElement.style.padding = "10px";
          messageElement.style.position = "absolute";
          messageElement.style.top = position.top + "px";
          messageElement.style.left = position.left + "px";
          messageElement.style.zIndex = 1000;

          messageElement.innerHTML = "<div>12345</div>";
          document.getElementById("ticker").appendChild(messageElement);
          
          setTimeout(function() {
            // messageElement.remove();
          }, 6000);
        }

        function showMessages() {
          showMessage("第一个提示框");
          
          setTimeout(function() {
            showMessage("第二个提示框");
          }, 1300);
          
          setTimeout(function() {
            showMessage("第三个提示框");
          }, 1500);
        }
        // showMessages();
    </script>
    <script>
      let series = null;
      let chart = null;
      let day =3;
      let month =6;
      let value =95.94;
      let num =3;
      let up =0;

      let data = [];
      let node = {};
      let seconds = new Date().getTime();
      for(let i=0; i < 320; i++) {
        node = { value: ticker[i].value, time: seconds + 200 };
        node.format = new Date(node.time).toLocaleTimeString();
        seconds = node.time;
        data.push(node);
      }

      secondLineInit(data, 380, 3);

      function setTransitionData(data) {
        let nodeList = [];
        let radio = 3.5;
        let start;
        let end;
        let dif;
        let step;
        data = ticker.reverse();
        // return data;
        for (let i = 20; i <= 200; i++) {
          if (i > 0) {
            start = Number(data[i-1].value);
            end = Number(data[i].value);
          } else {
            start = Number(data[0].value);
            end = Number(data[1].value);
          }
          dif = end - start;
          step = dif / radio;

          for (let v = 0; v <= radio; v++) {
            if (v === 0) {
              nodeList.push({ value: start - step * 0.65 });
              nodeList.push({ value: start - step * 0.8 });
              nodeList.push({ value: start - step * 0.65 });
              nodeList.push({ value: start });
            } else {
              let node = { value: start + step * v };
              nodeList.push(node);
            }
          }
        }

        return nodeList;
      }
      let nodeList = setTransitionData(ticker);

      let current = null;
      let length = 0;

      function callbackFn() {
        if (nodeList.length === 0) return;
        current = {
            time: data[data.length - 1].time + 125,
            value: nodeList[length].value,
            format: new Date(data[data.length - 1].time).toLocaleTimeString()
        };
        length++;
        data.push(current);

        setTimeout(() => {
          callbackFn();
        }, 125);
      }
      callbackFn();

      let time = 0;
      let run = () => {
          // if (time > 1) return;
          series.setData(data);
          // setTimeout(() => {
          //   run();
          // }, 3500);
          requestAnimationFrame(run);
      }
     run();
      
      
      // // #Apply
      // let handler = document.getElementById("handleEvent");
      // let scale = 11;
      // handler.addEventListener("click", function(e) {
      //     series.applyOptions({
      //       priceLineColor: 'red',
      //       priceFormat: {
      //           type: 'price',
      //           minMove: 0.0000001, // scale <= 1 ? 0.01 : Number(Number(0).toFixed(scale - 1) + 1), // 价格数值越小，minMove也要变小，否则纵坐标无法显示
      //           precision: 7,
      //       }
      //     });
      // });

      function secondLineInit(data, h, s) {
        let scale = s > 10 ? 10 : s;

        const container = document.getElementById("ticker");
        let width = container.offsetWidth;
        let height = container.offsetHeight;

        chart = window.LightweightCharts.createChart(container, {
          rightPriceScale: {
            minimumWidth: 30, // 纵座标与容器右侧的距离
            autoScale: true,
            scaleMargins: {
              top: 0.1,
              bottom: 0.1,
            }
          },
          timeScale: {
            ticksVisible: true,
            barSpacing: 3,  // 时间刻度的宽度, 使曲线变化比较平顺
            minBarSpacing: 0.0001,
            rightOffset: 30,  // 线与右侧的距离
            visible: true,
            secondsVisible: true,
            timeVisible: true,
            fixLeftEdge: false,
            borderVisible: true,
            tickMarkFormatter: (time, tickMarkType, locale) => {
              let date = new Date(time);
              return date.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }
          },
          layout: {
            background: {
                type: 'solid',
                color: '#ffffff',
            },
            textColor: 'rgba(0, 0, 0, .95)',
          },
          grid: {
            horzLines: {
              color: '#303030',
              visible: false
            },
            vertLines: {
              color: '#303030',
              visible: false
            },
          },
          crosshair: {
            vertLine: {
              labelVisible: false,
            },
            mode: 2
          },
          // 禁止缩放
          handleScale: {
              mouseWheel: false,
              pinch: false,
              axisPressedMouseMove: false
          },
        });

        chart.resize(width, height);

        series = chart.addAreaSeries({
          topColor: 'rgba(244, 196, 62, 0.55)',
          bottomColor: 'rgba(244, 196, 62, 0)',
          lineColor: '#ffd15c',
          lineWidth: 2,
          lineType: 2,
          lastPriceAnimation: 1,
          priceLineSource: 1,
          priceLineColor: '#13d519',
          lastValueVisible: true,
          priceFormat: {
              type: 'price',
              minMove: scale <= 1 ? 0.01 : Number(Number(0).toFixed(scale - 1) + 1), // 价格数值越小，minMove也要变小，否则纵坐标无法显示
              precision: scale,
          }
        });

        series.setData(data);
    }
    </script>
  </body>
</html>
